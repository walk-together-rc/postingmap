<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>一致団結ポスティングマップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      height: 100dvh;
      min-height: 100dvh;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    h1 {
      background-color: #e4007f;
      color: white;
      padding: 12px 10px 10px 10px;
      margin: 0;
      font-size: 1.3em;
      letter-spacing: 0.05em;
    }
    #form {
      padding: 10px;
      background-color: #f9f9f9;
      border-bottom: 1px solid #ccc;
      display: flex;
      gap: 1rem;
      align-items: center;
      font-size: 0.95em;
      flex-wrap: wrap;
      position: relative;
      z-index: 1002; /* ここでフォーム・ヘルプを地図より前面に */
    }
    #form label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
      min-width: 120px;
      margin-bottom: 4px;
      font-size: 1em;
    }
    #form input {
      margin-top: 4px;
      padding: 4px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 90px;
    }
    #map {
      flex: 1 1 auto;
      height: 70vh;
      width: 100%;
      min-height: 350px;
      max-height: 100dvh;
      z-index: 1;
    }
    .leaflet-div-icon {
      width: 6px !important;
      height: 6px !important;
      margin-left: -3px !important;
      margin-top: -3px !important;
      border-radius: 3px !important;
      border: 2px solid #e4007f !important;
      background: #fff !important;
    }
    /* フォーム右端のヘルプアイコン */
    .custom-help-container {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      z-index: 1003; /* 地図・フォームより前面に */
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      pointer-events: none;
    }
    .custom-help-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      color: #e4007f;
      border: 2px solid #e4007f;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      line-height: 28px;
      box-shadow: 0 2px 6px rgba(60,64,67,0.12);
      cursor: pointer;
      user-select: none;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    .custom-help-btn:active, .custom-help-btn:focus {
      background: #e4007f;
      color: #fff;
    }
    .custom-help-balloon {
      position: absolute;
      top: 38px;
      right: 0;
      width: 270px;
      max-width: 70vw;
      background: #fff;
      color: #333;
      font-size: 1em;
      border: 1.5px solid #e4007f;
      border-radius: 7px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.16);
      padding: 15px 14px 15px 18px;
      z-index: 1004; /* 吹き出しが必ず最前面になるように */
      pointer-events: auto;
      word-break: break-word;
      line-height: 1.7;
      display: none;
    }
    .custom-help-balloon:before {
      content: "";
      position: absolute;
      top: -13px;
      right: 20px;
      border: 7px solid transparent;
      border-bottom: 10px solid #e4007f;
    }
    .custom-help-balloon:after {
      content: "";
      position: absolute;
      top: -11px;
      right: 22px;
      border: 6px solid transparent;
      border-bottom: 10px solid #fff;
    }
    @media (max-width: 600px) {
      #form {
        padding: 6px 3vw 6px 3vw;
        gap: 0.4rem;
        font-size: 0.9em;
      }
      #form label {
        min-width: 90px;
        font-size: 0.95em;
      }
      #form input {
        font-size: 0.93em;
        min-width: 70px;
      }
      .custom-help-btn {
        width: 28px;
        height: 28px;
        font-size: 18px;
        line-height: 24px;
      }
      .custom-help-balloon {
        width: 90vw;
        max-width: 95vw;
        font-size: 0.98em;
        right: 0;
        top: 32px;
        padding: 11px 8px 11px 13px;
      }
      .custom-help-balloon:before {
        right: 16px;
      }
      .custom-help-balloon:after {
        right: 18px;
      }
    }
    @media (max-width: 400px) {
      #form label {
        min-width: 70px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <h1>一致団結ポスティングマップ</h1>
  <div id="form">
    <label>実施日（必須）
      <input type="date" id="date" required />
    </label>
    <label>名前（任意）
      <input type="text" id="name" />
    </label>
    <!-- フォーム右端 ヘルプボタン&吹き出し -->
    <div class="custom-help-container" id="customHelpContainer">
      <button class="custom-help-btn" id="customHelpBtn" title="操作方法">？</button>
      <div class="custom-help-balloon" id="customHelpBalloon">
        ＜操作方法＞<br>
        1. 実施日・名前を入力する<br>
        2. サイドメニューから「ポリゴンを描画」を選択し、ポスティング実施エリアを囲うようにしてマーキングする<br>
        <br>
        修正は図形を1クリック、削除は2クリックでできます。
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // 日本語化
    if (window.L && window.L.drawLocal) {
      L.drawLocal.draw.toolbar.buttons.polygon = 'ポリゴンを描画';
      L.drawLocal.draw.handlers.polygon.tooltip.start = 'クリックしてポリゴンの最初の点を指定';
      L.drawLocal.draw.handlers.polygon.tooltip.cont = 'クリックしてポリゴンの次の点を指定';
      L.drawLocal.draw.handlers.polygon.tooltip.end = '最初の点をクリックしてポリゴンを閉じる';
      L.drawLocal.edit.toolbar.buttons.edit = '図形を編集';
      L.drawLocal.edit.toolbar.buttons.remove = '図形を削除';
    }
    // 地図初期化
    const map = L.map('map', { tap: false }).setView([35.6996, 139.7652], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);

    const drawControl = new L.Control.Draw({
      position: 'topleft',
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: {
          allowIntersection: false,
          showArea: true,
          shapeOptions: {
            color: "#e4007f",
            fillColor: "#e4007f",
            fillOpacity: 0.4
          },
          icon: new L.DivIcon({
            iconSize: new L.Point(6, 6),
            className: 'leaflet-div-icon'
          })
        },
        polyline: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // --- ここから自動送信機能 ---
    function getAllPolygonsGeoJSON() {
      const polygons = [];
      drawnItems.eachLayer(function (layer) {
        if (layer instanceof L.Polygon) {
          polygons.push(layer.toGeoJSON().geometry.coordinates);
        }
      });
      return polygons;
    }

    async function sendPolygonsToServer() {
      const date = document.getElementById("date").value;
      const name = document.getElementById("name").value;
      const polygons = getAllPolygonsGeoJSON();

      if (!date) {
        alert("実施日を入力してください");
        return;
      }
      // polygon（配列）は空でも送信します（全部消したパターンにも対応）

      try {
        const res = await fetch('http://localhost:3001/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date,
            name,
            polygon: polygons
          })
        });
        const result = await res.json();
        if (result.status === 'ok') {
          console.log('スプレッドシートに保存しました');
        } else {
          alert('保存に失敗しました: ' + (result.error || ''));
        }
      } catch (error) {
        alert('サーバーに接続できませんでした');
      }
    }

    // ポリゴン追加時
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      sendPolygonsToServer();
    });

    // ポリゴン編集時
    map.on('draw:edited', function (e) {
      sendPolygonsToServer();
    });

    // ポリゴン削除時
    map.on('draw:deleted', function (e) {
      sendPolygonsToServer();
    });

    // 情報管理
    const polygonMetaMap = new Map();

    // 編集中のlayerを管理
    let editingLayer = null;

    function enableEdit(layer) {
      if (editingLayer && editingLayer !== layer) {
        disableEdit(editingLayer);
      }
      editingLayer = layer;
      drawnItems.fire('editstart');
      layer.editing && layer.editing.enable && layer.editing.enable();
    }
    function disableEdit(layer) {
      if (!layer) return;
      layer.editing && layer.editing.disable && layer.editing.disable();
      drawnItems.fire('editstop');
      editingLayer = null;
    }

    // ポリゴン追加
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      const date = document.getElementById("date").value;
      const name = document.getElementById("name").value;
      if (!date) {
        alert("実施日を入力してください");
        return;
      }
      polygonMetaMap.set(layer._leaflet_id, { date, name });
      drawnItems.addLayer(layer);
      setupPolygonEvents(layer, date, name);
    });

    // 編集後もポップアップ内容再設定
    map.on('draw:edited', function (e) {
      e.layers.eachLayer(function (layer) {
        if (polygonMetaMap.has(layer._leaflet_id)) {
          const meta = polygonMetaMap.get(layer._leaflet_id);
          setupPolygonEvents(layer, meta.date, meta.name);
        }
      });
    });

    // ==== ポリゴンイベント設定（スマホ2回タップ対応） ====
    function setupPolygonEvents(layer, date, name) {
      // 既存のポップアップをクリア
      layer.unbindPopup();
      const popupContent = `<strong>実施日:</strong> ${date}<br><strong>名前:</strong> ${name || "（なし）"}`;
      let isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if (isTouch) {
        // タッチデバイス用：2回タップで削除
        let lastTap = 0;
        layer.on('click', function(e) {
          const now = Date.now();
          if (now - lastTap < 300) {
            // 2回目のタップ（ダブルタップ）
            L.DomEvent.stopPropagation(e);
            if (confirm("この図形を削除しますか？")) {
              drawnItems.removeLayer(layer);
              polygonMetaMap.delete(layer._leaflet_id);
              if (editingLayer === layer) editingLayer = null;
              sendPolygonsToServer(); // 削除時もサーバー送信
            }
            lastTap = 0;
          } else {
            // 1回めのタップ（編集＆ポップアップ表示）
            layer.bindPopup(popupContent, { closeButton: false, autoPan: true }).openPopup();
            setTimeout(() => {
              enableEdit(layer);
            }, 350);
            lastTap = now;
          }
        });
        map.on('click', function(e) {
          layer.closePopup();
        });
      } else {
        // PC用（マウス）
        layer.on('mouseover', function(e) {
          layer.bindPopup(popupContent, { closeButton: false, autoPan: false }).openPopup();
        });
        layer.on('mouseout', function(e) {
          layer.closePopup();
        });
        layer.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          enableEdit(layer);
        });
        // ダブルクリックで削除
        layer.on('dblclick', function(e) {
          L.DomEvent.stopPropagation(e);
          if (confirm("この図形を削除しますか？")) {
            drawnItems.removeLayer(layer);
            polygonMetaMap.delete(layer._leaflet_id);
            if (editingLayer === layer) editingLayer = null;
            sendPolygonsToServer(); // 削除時もサーバー送信
          }
        });
      }
    }

    drawnItems.eachLayer(function(layer) {
      const meta = polygonMetaMap.get(layer._leaflet_id);
      if (meta) setupPolygonEvents(layer, meta.date, meta.name);
    });

    // 地図クリックで編集終了（図形上クリック時は停止済み）
    map.on('click', function(e) {
      if (editingLayer) {
        disableEdit(editingLayer);
      }
    });

    // iOS Safari用 高さリサイズ
    function resizeMapHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
      const mapDiv = document.getElementById('map');
      if (window.innerWidth <= 600) {
        mapDiv.style.height = (window.innerHeight - document.getElementById('form').offsetHeight - document.querySelector('h1').offsetHeight - 12) + 'px';
      } else {
        mapDiv.style.height = '';
      }
    }
    window.addEventListener('resize', resizeMapHeight);
    window.addEventListener('orientationchange', resizeMapHeight);
    resizeMapHeight();

    // ヘルプボタンのふきだし表示制御
    const helpBtn = document.getElementById('customHelpBtn');
    const helpBalloon = document.getElementById('customHelpBalloon');
    let helpOpen = false;
    function toggleHelpBalloon(e) {
      e.stopPropagation();
      helpOpen = !helpOpen;
      helpBalloon.style.display = helpOpen ? 'block' : 'none';
    }
    helpBtn.addEventListener('click', toggleHelpBalloon);
    // バルーン以外クリックで閉じる
    document.addEventListener('click', function(e) {
      if (helpOpen && !helpBtn.contains(e.target) && !helpBalloon.contains(e.target)) {
        helpBalloon.style.display = 'none';
        helpOpen = false;
      }
    });
  </script>
</body>
</html>
