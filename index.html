<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>一致団結ポスティングマップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; margin: 0; padding: 0; height: 100dvh; min-height: 100dvh; background: #fff; display: flex; flex-direction: column; }
    h1 { background-color: #e4007f; color: white; padding: 12px 10px 10px 10px; margin: 0; font-size: 1.3em; letter-spacing: 0.05em; }
    #form { padding: 10px; background-color: #f9f9f9; border-bottom: 1px solid #ccc; display: flex; gap: 1rem; align-items: center; font-size: 0.95em; flex-wrap: wrap; position: relative; z-index: 1002; }
    #form label { display: flex; flex-direction: column; font-weight: bold; min-width: 120px; margin-bottom: 4px; font-size: 1em; cursor: pointer; }
    #form input { margin-top: 4px; padding: 4px; font-size: 0.95em; border: 1px solid #ccc; border-radius: 4px; min-width: 90px; box-sizing: border-box; }
    @media (max-width: 600px) {
      #form input { font-size: 16px !important; }
    }
    #map { flex: 1 1 auto; height: 70vh; width: 100%; min-height: 350px; max-height: 100dvh; z-index: 1; }
    .leaflet-div-icon { width: 6px !important; height: 6px !important; margin-left: -3px !important; margin-top: -3px !important; border-radius: 3px !important; border: 2px solid #e4007f !important; background: #fff !important; }
    .custom-help-container { position: absolute; top: 50%; right: 8px; transform: translateY(-50%); z-index: 1003; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
    .custom-help-btn { width: 32px; height: 32px; border-radius: 50%; background: #fff; color: #e4007f; border: 2px solid #e4007f; font-size: 22px; font-weight: bold; text-align: center; line-height: 28px; box-shadow: 0 2px 6px rgba(60,64,67,0.12); cursor: pointer; user-select: none; pointer-events: auto; display: flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; }
    .custom-help-btn:active, .custom-help-btn:focus { background: #e4007f; color: #fff; }
    .custom-help-balloon { position: absolute; top: 38px; right: 0; width: 270px; max-width: 70vw; background: #fff; color: #333; font-size: 1em; border: 1.5px solid #e4007f; border-radius: 7px; box-shadow: 0 2px 12px rgba(0,0,0,0.16); padding: 15px 14px 15px 18px; z-index: 1004; pointer-events: auto; word-break: break-word; line-height: 1.7; display: none; }
    .custom-help-balloon:before { content: ""; position: absolute; top: -13px; right: 20px; border: 7px solid transparent; border-bottom: 10px solid #e4007f; }
    .custom-help-balloon:after { content: ""; position: absolute; top: -11px; right: 22px; border: 6px solid transparent; border-bottom: 10px solid #fff; }
    .leaflet-popup-close-button { display: none !important; }
    .leaflet-draw-toolbar .leaflet-draw-remove {
      width: 30px; height: 30px; margin: 7px 0 0 0; background: #fff;
      border: 2px solid #666; border-radius: 4px; box-shadow: 0 1.5px 6px rgba(60,64,67,0.12);
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    .leaflet-draw-toolbar .leaflet-draw-remove svg {
      width: 20px; height: 20px; display: block;
    }
    .leaflet-draw-toolbar .leaflet-draw-remove:hover {
      background: #eee;
      border-color: #e4007f;
    }
    .leaflet-draw-toolbar .leaflet-draw-remove:active {
      background: #e4007f;
      border-color: #e4007f;
    }
    /* 削除ツールバーの「Clear All」非表示 */
    .leaflet-draw-actions li.leaflet-draw-action[title*="Clear All"],
    .leaflet-draw-actions li.leaflet-draw-action[title*="全削除"],
    .leaflet-draw-actions li.leaflet-draw-action[title*="クリア"] {
      display: none !important;
    }
    @media (max-width: 600px) {
      #form { padding: 6px 3vw 6px 3vw; gap: 0.4rem; font-size: 0.9em; }
      #form label { min-width: 90px; font-size: 0.95em; }
      #form input { font-size: 16px !important; min-width: 70px; }
      .custom-help-btn { width: 28px; height: 28px; font-size: 18px; line-height: 24px; }
      .custom-help-balloon { width: 90vw; max-width: 95vw; font-size: 0.98em; right: 0; top: 32px; padding: 11px 8px 11px 13px; }
      .custom-help-balloon:before { right: 16px; }
      .custom-help-balloon:after { right: 18px; }
      .leaflet-draw-toolbar .leaflet-draw-remove { width: 28px; height: 28px; }
      .leaflet-draw-toolbar .leaflet-draw-remove svg { width: 17px; height: 17px; }
    }
    @media (max-width: 400px) {
      #form label { min-width: 70px; font-size: 0.9em; }
    }
    .leaflet-draw-toolbar .leaflet-draw-edit-edit { display: none !important; }
  </style>
</head>
<body>
  <h1>一致団結ポスティングマップ</h1>
  <div id="form">
    <label for="date" id="date-label">実施日（必須）
      <input type="date" id="date" required />
    </label>
    <label>名前（任意）
      <input type="text" id="name" style="font-size:16px;" inputmode="text" />
    </label>
    <div class="custom-help-container" id="customHelpContainer">
      <button class="custom-help-btn" id="customHelpBtn" title="操作方法">？</button>
      <div class="custom-help-balloon" id="customHelpBalloon">
        ＜操作方法＞<br>
        1. 実施日・名前を入力する<br>
        2. サイドメニューから「ポリゴンを描画」を選択し、ポスティング実施エリアを囲うようにしてマーキングする<br>
        <br>
        ■図形の編集<br>
        図形選択→自由に変形→図形以外をタップ<br>
        <br>
        ■図形の削除<br>
        削除ボタン→図形選択→Saveボタン
      </div>
    </div>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // 日本語化
    if (window.L && window.L.drawLocal) {
      L.drawLocal.draw.toolbar.buttons.polygon = 'ポリゴンを描画';
      L.drawLocal.edit.toolbar.buttons.edit = '';
      L.drawLocal.edit.toolbar.buttons.remove = '削除';
      L.drawLocal.edit.handlers.remove.tooltip.text = '削除したいポリゴンをクリックしてください';
      L.drawLocal.edit.handlers.remove.tooltip.subtext = 'もう一度クリックで削除を解除';
    }

    // 地図初期化
    const map = L.map('map', { tap: false }).setView([35.6996, 139.7652], 13);
    window.map = map; // グローバルに
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const drawnItems = new L.FeatureGroup().addTo(map);

    // ポリゴン基本style
    const polygonStyle = {
      color: "#e4007f",
      fillColor: "#e4007f",
      fillOpacity: 0.4
    };

    // ポリゴン描画ボタン＋削除ボタンのみ表示
    const drawControl = new L.Control.Draw({
      position: 'topleft',
      edit: { featureGroup: drawnItems, edit: false, remove: true },
      draw: {
        polygon: {
          allowIntersection: false,
          showArea: true,
          shapeOptions: polygonStyle,
          icon: new L.DivIcon({
            iconSize: new L.Point(6, 6),
            className: 'leaflet-div-icon'
          })
        },
        polyline: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // 削除ボタンのLeaflet DrawデフォルトUIの位置調整&SVG差し替え
    function customizeRemoveBtn() {
      const toolbar = document.querySelector('.leaflet-draw-toolbar-top');
      if (!toolbar) return;
      let removeBtn = toolbar.querySelector('.leaflet-draw-edit-remove');
      if (removeBtn) {
        removeBtn.classList.add('leaflet-draw-remove');
        // SVGリセット
        removeBtn.innerHTML = `
        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#d32f2f"/></svg>
        `;
      }
      // 「Clear All」アクションを非表示
      const actions = document.querySelectorAll('.leaflet-draw-actions li.leaflet-draw-action');
      actions.forEach(li => {
        const t = li.getAttribute('title') || '';
        if (t.includes('Clear All') || t.includes('全削除') || t.includes('クリア')) {
          li.style.display = 'none';
        }
      });
    }
    setTimeout(customizeRemoveBtn, 500);

    // ---- ここから吹き出し＆編集仕様 ----
    function bindPolygonInfo(layer, date, name) {
      let infoHtml = `実施日: ${date || "(未入力)"}<br>名前: ${name || "(未入力)"}`;
      layer.unbindPopup && layer.unbindPopup();
      layer.bindPopup(infoHtml, { closeButton: false });
      layer.off();

      // スマホ判定
      const isTouch = 'ontouchstart' in window || window.matchMedia('(pointer: coarse)').matches;

      if (isTouch) {
        // スマホ：1タップで吹き出し＆編集
        layer.on('click', function(e) {
          layer.openPopup();
          startEditMode(layer);
        });
      } else {
        // PC：マウスオーバーで吹き出し、1クリックで編集
        layer.on('mouseover', function(e) { layer.openPopup(); });
        layer.on('mouseout', function(e) { layer.closePopup(); });
        layer.on('click', function(e) {
          startEditMode(layer);
        });
      }
    }

    // 編集モード起動＆終了
    function startEditMode(layer) {
      if (map._editingPolygon) return;
      map._editingPolygon = layer;
      const editLayerGroup = new L.FeatureGroup();
      editLayerGroup.addLayer(layer);
      const editHandler = new L.EditToolbar.Edit(map, { featureGroup: editLayerGroup });
      editHandler.enable();

      // 図形以外クリック/タップで終了
      function isTouch() {
        return 'ontouchstart' in window || window.matchMedia('(pointer: coarse)').matches;
      }
      function finishEdit(ev) {
        editHandler.disable();
        editLayerGroup.clearLayers();
        if (layer.toGeoJSON) {
          const geojson = layer.toGeoJSON();
          const date = geojson.properties && geojson.properties.date || document.getElementById('date').value;
          const name = geojson.properties && geojson.properties.name || document.getElementById('name').value;
          fetch('http://localhost:3001/api/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: layer.feature?.properties?.id,
              date,
              name,
              polygon: geojson
            })
          });
        }
        map.off(isTouch() ? 'touchstart' : 'click', finishEdit);
        map._editingPolygon = null;
      }
      setTimeout(() => {
        map.once(isTouch() ? 'touchstart' : 'click', function(ev) {
          // 図形以外
          if (!ev.originalEvent || !ev.originalEvent.target.closest('.leaflet-interactive')) {
            finishEdit(ev);
          }
        });
      }, 100);
    }

    function applyLayerBindings(layer, geojson) {
      const date = geojson.properties && geojson.properties.date;
      const name = geojson.properties && geojson.properties.name;
      bindPolygonInfo(layer, date, name);
    }
    // ---- ここまで ----

    // ページ表示時に全ポリゴン取得して描画
    window.addEventListener('DOMContentLoaded', function() {
      fetch('http://localhost:3001/api/polygons')
        .then(res => res.json())
        .then(polygons => {
          drawnItems.clearLayers();
          polygons.forEach(geojson => {
            if (
              geojson &&
              geojson.type === "Feature" &&
              geojson.geometry &&
              geojson.geometry.type === "Polygon" &&
              Array.isArray(geojson.geometry.coordinates)
            ) {
              L.geoJSON(geojson, { style: polygonStyle }).eachLayer(layer => {
                applyLayerBindings(layer, geojson);
                drawnItems.addLayer(layer);
              });
            }
          });
        });
    });

    // ポリゴン新規作成
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      layer.setStyle && layer.setStyle(polygonStyle);
      drawnItems.addLayer(layer);
      const date = document.getElementById("date").value;
      const name = document.getElementById("name").value;
      if (!date) {
        alert("実施日を入力してください");
        drawnItems.removeLayer(layer);
        return;
      }
      fetch('http://localhost:3001/api/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date,
          name,
          polygon: layer.toGeoJSON()
        })
      }).then(res => res.json())
        .then(json => {
          if (json.status === 'ok' && json.id) {
            layer.feature = layer.feature || {};
            layer.feature.properties = layer.feature.properties || {};
            layer.feature.properties.id = json.id;
            layer.feature.properties.date = date;
            layer.feature.properties.name = name;
            applyLayerBindings(layer, { properties: { id: json.id, date, name } });
          } else {
            alert('保存に失敗しました: ' + (json.error || ''));
            drawnItems.removeLayer(layer);
          }
        });
    });

    // 編集時も保存
    map.on('draw:edited', function (e) {
      e.layers.eachLayer(function (layer) {
        let geojson = layer.toGeoJSON();
        let id = geojson.properties && geojson.properties.id;
        const date = geojson.properties && geojson.properties.date || document.getElementById("date").value;
        const name = geojson.properties && geojson.properties.name || document.getElementById("name").value;
        fetch('http://localhost:3001/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: id,
            date,
            name,
            polygon: geojson
          })
        });
      });
    });

    // 削除イベント（draw:deleted）でサーバー側も一括削除
    map.on('draw:deleted', function (e) {
      let ids = [];
      e.layers.eachLayer(function (layer) {
        let geojson = layer.toGeoJSON();
        let id = geojson.properties && geojson.properties.id;
        if (id) {
          ids.push(id);
        }
      });
      if (ids.length === 0) return;
      fetch('http://localhost:3001/api/delete-multi', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: ids })
      }).then(res => res.json())
        .then(result => {
          if (!result.status || result.status !== "ok") {
            alert('一部の削除に失敗しました');
          }
        })
        .catch(err => {
          alert('削除処理でエラーが発生しました');
        });
    });

    // ヘルプボタンのふきだし表示制御
    const helpBtn = document.getElementById('customHelpBtn');
    const helpBalloon = document.getElementById('customHelpBalloon');
    let helpOpen = false;
    function toggleHelpBalloon(e) {
      e.stopPropagation();
      helpOpen = !helpOpen;
      helpBalloon.style.display = helpOpen ? 'block' : 'none';
    }
    helpBtn.addEventListener('click', toggleHelpBalloon);
    document.addEventListener('click', function(e) {
      if (helpOpen && !helpBtn.contains(e.target) && !helpBalloon.contains(e.target)) {
        helpBalloon.style.display = 'none';
        helpOpen = false;
      }
    });
  </script>
</body>
</html>
